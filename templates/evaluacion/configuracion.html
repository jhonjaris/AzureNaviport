{% extends 'base.html' %}

{% block title %}Configuraci√≥n | NaviPort RD{% endblock %}

{% block content %}
{% include 'includes/navbar_evaluador.html' with active_page='config' %}

<div class="content-area">
    <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2 style="color: #2c3e50; margin: 0;">‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                <p style="color: #7f8c8d; margin: 5px 0 0 0;">{{ user.get_display_name }} ‚Ä¢ Evaluador Portuario</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="{% url 'evaluacion:gestionar_empresas' %}" class="btn" style="background: #3498db; color: white;">
                    üè¢ Gesti√≥n de Empresas
                </a>
                <a href="{% url 'accounts:gestionar_usuarios' %}" class="btn" style="background: #2c3e50; color: white;">
                    üë• Gesti√≥n de Usuarios
                </a>
                <a href="{% url 'evaluacion:gestionar_servicios' %}" class="btn" style="background: #9b59b6; color: white;">
                    üõ°Ô∏è Servicios
                </a>
                <a href="{% url 'evaluacion:gestionar_tipos_licencia' %}" class="btn" style="background: #f39c12; color: white;">
                    üè∑Ô∏è Licencias
                </a>
                <a href="{% url 'notificaciones:configuracion_correo' %}" class="btn" style="background: #e74c3c; color: white;">
                    üìß Notificaciones por Correo
                </a>
                <a href="{% url 'evaluacion:gestion_puertos' %}" class="btn" style="background: #27ae60; color: white;">
                    üè† Cat√°logo de Instalaciones Portuarias
                </a>
            </div>
        </div>
    </div>

    <!-- General Content -->
        <div class="data-table">
            <div class="table-header">
                <div class="table-title">Reglas de Validaci√≥n de Empresas</div>
            </div>
        
        <div style="padding: 30px;">
            <form method="POST" novalidate>
                {% csrf_token %}
                
                <!-- Configuraci√≥n de Preaviso -->
                <fieldset style="border: none; margin: 0; padding: 0;">
                    <legend style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;">
                        ‚è∞ D√≠as de Preaviso de Expiraci√≥n
                    </legend>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <small style="color: #6c757d;">
                            <strong>üí° Ayuda:</strong> Configure cu√°ntos d√≠as antes de la expiraci√≥n se deben mostrar las alertas.
                            Los valores deben estar en orden: Cr√≠tico < Advertencia < Informativo.
                        </small>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div>
                            <label for="{{ form.dias_preaviso_critico.id_for_label }}" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                                üî¥ Preaviso Cr√≠tico (d√≠as)
                            </label>
                            {{ form.dias_preaviso_critico }}
                            {% if form.dias_preaviso_critico.errors %}
                                <div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">
                                    {{ form.dias_preaviso_critico.errors.0 }}
                                </div>
                            {% endif %}
                            <small style="color: #6c757d; font-size: 12px;">Ej: 30 d√≠as - Estado cr√≠tico</small>
                        </div>
                        
                        <div>
                            <label for="{{ form.dias_preaviso_advertencia.id_for_label }}" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                                üü† Preaviso Advertencia (d√≠as)
                            </label>
                            {{ form.dias_preaviso_advertencia }}
                            {% if form.dias_preaviso_advertencia.errors %}
                                <div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">
                                    {{ form.dias_preaviso_advertencia.errors.0 }}
                                </div>
                            {% endif %}
                            <small style="color: #6c757d; font-size: 12px;">Ej: 60 d√≠as - Estado de advertencia</small>
                        </div>
                        
                        <div>
                            <label for="{{ form.dias_preaviso_informativo.id_for_label }}" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                                üü° Preaviso Informativo (d√≠as)
                            </label>
                            {{ form.dias_preaviso_informativo }}
                            {% if form.dias_preaviso_informativo.errors %}
                                <div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">
                                    {{ form.dias_preaviso_informativo.errors.0 }}
                                </div>
                            {% endif %}
                            <small style="color: #6c757d; font-size: 12px;">Ej: 90 d√≠as - Estado informativo</small>
                        </div>
                    </div>
                </fieldset>

                <!-- Tipo de Expiraci√≥n Principal -->
                <fieldset style="border: none; margin: 0; padding: 0;">
                    <legend style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                        üìã Tipo de Expiraci√≥n a Considerar
                    </legend>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <small style="color: #1565c0;">
                            <strong>üìå Importante:</strong> Seleccione qu√© fecha de expiraci√≥n debe tener prioridad para las alertas y validaciones.
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <label for="{{ form.tipo_expiracion_principal.id_for_label }}" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                            Expiraci√≥n Principal
                        </label>
                        {{ form.tipo_expiracion_principal }}
                        {% if form.tipo_expiracion_principal.errors %}
                            <div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">
                                {{ form.tipo_expiracion_principal.errors.0 }}
                            </div>
                        {% endif %}
                        <small style="color: #6c757d; font-size: 12px;">
                            Esta ser√° la fecha utilizada para calcular los estados de las empresas
                        </small>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div>
                            <label for="{{ form.enlace_instrucciones.id_for_label }}" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                                üîó Enlace de Instrucciones para Renovaci√≥n
                            </label>
                            {{ form.enlace_instrucciones }}
                            {% if form.enlace_instrucciones.errors %}
                                <div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">
                                    {{ form.enlace_instrucciones.errors.0 }}
                                </div>
                            {% endif %}
                            <small style="color: #6c757d; font-size: 12px;">
                                Este enlace aparecer√° en los avisos de expiraci√≥n
                            </small>
                        </div>
                        
                        <div>
                            <label for="{{ form.tiempo_respuesta_horas.id_for_label }}" style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                                ‚è±Ô∏è Tiempo de Respuesta (horas)
                            </label>
                            {{ form.tiempo_respuesta_horas }}
                            {% if form.tiempo_respuesta_horas.errors %}
                                <div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">
                                    {{ form.tiempo_respuesta_horas.errors.0 }}
                                </div>
                            {% endif %}
                            <small style="color: #6c757d; font-size: 12px;">
                                Tiempo establecido en la carta compromiso
                            </small>
                        </div>
                    </div>
                </fieldset>

                <!-- Configuraci√≥n Adicional -->
                <fieldset style="border: none; margin: 0; padding: 0;">
                    <legend style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #27ae60; padding-bottom: 10px;">
                        üîß Configuraci√≥n Adicional
                    </legend>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            {{ form.notificar_empresas_vencidas }}
                            <label for="{{ form.notificar_empresas_vencidas.id_for_label }}" style="margin: 0; font-weight: 500; color: #495057;">
                                üîî Notificar empresas con licencias vencidas
                            </label>
                            {% if form.notificar_empresas_vencidas.errors %}
                                <div style="color: #e74c3c; font-size: 12px; margin-left: 10px;">
                                    {{ form.notificar_empresas_vencidas.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </fieldset>

                <!-- Botones de Acci√≥n -->
                <div style="padding-top: 20px; border-top: 1px solid #dee2e6; display: flex; gap: 15px; justify-content: flex-end;">
                    <a href="{% url 'evaluacion:dashboard' %}" class="btn" style="background: #6c757d; color: white; padding: 12px 24px;">
                        Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary" style="padding: 12px 24px;">
                        üíæ Guardar Configuraci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informaci√≥n Actual -->
    <div class="data-table" style="margin-top: 30px;">
        <div class="table-header">
            <div class="table-title">Configuraci√≥n Actual</div>
        </div>
        
        <div style="padding: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üìä D√≠as de Preaviso</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                        <li>üî¥ Cr√≠tico: {{ config.dias_preaviso_critico }} d√≠as</li>
                        <li>üü† Advertencia: {{ config.dias_preaviso_advertencia }} d√≠as</li>
                        <li>üü° Informativo: {{ config.dias_preaviso_informativo }} d√≠as</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">‚öôÔ∏è Configuraci√≥n</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                        <li>üìã Expiraci√≥n principal: {{ config.get_tipo_expiracion_principal_display }}</li>
                        <li>‚è±Ô∏è Tiempo de respuesta: {{ config.tiempo_respuesta_horas }} horas</li>
                        <li>üîó Enlace instrucciones: {% if config.enlace_instrucciones %}<a href="{{ config.enlace_instrucciones }}" target="_blank">{{ config.enlace_instrucciones }}</a>{% else %}No configurado{% endif %}</li>
                        <li>üîî Notificaciones: {% if config.notificar_empresas_vencidas %}Activadas{% else %}Desactivadas{% endif %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validaci√≥n en tiempo real para los d√≠as de preaviso
    const critico = document.getElementById('{{ form.dias_preaviso_critico.id_for_label }}');
    const advertencia = document.getElementById('{{ form.dias_preaviso_advertencia.id_for_label }}');
    const informativo = document.getElementById('{{ form.dias_preaviso_informativo.id_for_label }}');
    
    function validarOrden() {
        const valorCritico = parseInt(critico.value) || 0;
        const valorAdvertencia = parseInt(advertencia.value) || 0;
        const valorInformativo = parseInt(informativo.value) || 0;
        
        if (valorCritico >= valorAdvertencia && valorAdvertencia > 0) {
            advertencia.style.borderColor = '#e74c3c';
            mostrarMensaje('Los d√≠as cr√≠ticos deben ser menores que los de advertencia', 'error');
        } else {
            advertencia.style.borderColor = '#ced4da';
        }
        
        if (valorAdvertencia >= valorInformativo && valorInformativo > 0) {
            informativo.style.borderColor = '#e74c3c';
            mostrarMensaje('Los d√≠as de advertencia deben ser menores que los informativos', 'error');
        } else {
            informativo.style.borderColor = '#ced4da';
        }
    }
    
    function mostrarMensaje(texto, tipo) {
        // Eliminar mensajes anteriores
        const mensajesAnteriores = document.querySelectorAll('.mensaje-validacion');
        mensajesAnteriores.forEach(m => m.remove());
        
        // Crear nuevo mensaje (opcional - puedes mostrar tooltips o alertas)
        console.log(`${tipo.toUpperCase()}: ${texto}`);
    }
    
    if (critico && advertencia && informativo) {
        critico.addEventListener('blur', validarOrden);
        advertencia.addEventListener('blur', validarOrden);
        informativo.addEventListener('blur', validarOrden);
    }
});
</script>

{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}Evaluar Solicitud {{ solicitud.codigo }} | NaviPort RD{% endblock %}

{% block content %}
{% include 'includes/navbar_evaluador.html' with active_page='dashboard' %}
<div class="content-area">
    <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h2 style="color: #2c3e50; margin-bottom: 10px;">üìã Evaluaci√≥n de Solicitud</h2>
                <p style="color: #7f8c8d;">C√≥digo: {{ solicitud.codigo }} ‚Ä¢ Estado: {{ solicitud.get_estado_display }}</p>
            </div>
            <div style="display: flex; gap: 10px;" class="no-print">
                <button onclick="window.print()" class="btn-imprimir">
                    üñ®Ô∏è Imprimir Solicitud
                </button>
                {% if solicitud.estado == 'aprobada' %}
                <a href="{% url 'solicitudes:imprimir_autorizacion' solicitud.id %}" target="_blank" class="btn-imprimir-autorizacion">
                    üé´ Imprimir Autorizaci√≥n
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Informaci√≥n de la Solicitud -->
        <div>
            <!-- Informaci√≥n B√°sica -->
            <div class="form-container" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">üè¢ Informaci√≥n de la Empresa</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <strong>Empresa:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.empresa.nombre }}</p>
                    </div>
                    <div>
                        <strong>RNC:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.empresa.rnc }}</p>
                    </div>
                    <div>
                        <strong>Solicitante:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.solicitante.get_display_name }}</p>
                    </div>
                    <div>
                        <strong>C√©dula/RNC:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.solicitante.cedula_rnc }}</p>
                    </div>
                </div>
            </div>

            <!-- Detalles del Acceso -->
            <div class="form-container" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">üìç Detalles del Acceso</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <strong>üö¢ N√∫mero de IMO:</strong>
                        <p style="margin: 5px 0; padding: 10px; background: #e3f2fd; border-radius: 4px; font-weight: 600;">{{ solicitud.numero_imo|default:"No especificado" }}</p>
                    </div>
                    <div>
                        <strong>üè¢ Naviera:</strong>
                        <p style="margin: 5px 0; padding: 10px; background: #e3f2fd; border-radius: 4px; font-weight: 600;">{{ solicitud.naviera|default:"No especificada" }}</p>
                    </div>
                    <div>
                        <strong>Puerto de Destino:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.puerto_destino.nombre }}</p>
                    </div>
                    <div>
                        <strong>Lugar de Destino:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.lugar_destino.nombre|default:"No especificado" }}</p>
                    </div>
                    <div>
                        <strong>Motivo del Acceso:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.motivo_acceso.nombre }}</p>
                    </div>
                    <div>
                        <strong>Prioridad:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.get_prioridad_display }}</p>
                    </div>
                    <div>
                        <strong>Fecha y Hora de Ingreso:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.fecha_ingreso|date:'d/m/Y' }} a las {{ solicitud.hora_ingreso|time:'H:i' }}</p>
                    </div>
                    <div>
                        <strong>Fecha y Hora de Salida:</strong>
                        <p style="margin: 5px 0;">{{ solicitud.fecha_salida|date:'d/m/Y' }} a las {{ solicitud.hora_salida|time:'H:i' }}</p>
                    </div>
                </div>
                <div>
                    <strong>Descripci√≥n Detallada:</strong>
                    <p style="margin: 5px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">{{ solicitud.descripcion }}</p>
                </div>
            </div>

            <!-- Servicios Solicitados y Documentos -->
            <div class="form-container" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">üõ†Ô∏è Servicios Solicitados y Documentos</h3>

                {% if servicios %}
                <div style="margin-bottom: 20px;">
                    <strong style="color: #555; font-size: 14px;">Servicios:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        {% for servicio in servicios %}
                        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 8px; padding: 12px 18px;">
                            <strong style="color: #2e7d32;">{{ servicio.codigo }}</strong>
                            <span style="margin-left: 8px; color: #1b5e20;">{{ servicio.nombre }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404; margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Sin servicios:</strong> No se han seleccionado servicios para esta solicitud.
                </div>
                {% endif %}

                <!-- Documentos de los Servicios -->
                <div style="margin-top: 20px;">
                    <strong style="color: #555; font-size: 14px;">üìé Documentos Adjuntos del Servicio:</strong>
                    {% if documentos_servicios %}
                    <div class="documentos-servicios-grid" style="margin-top: 15px;">
                        {% for doc_servicio in documentos_servicios %}
                        <div class="documento-servicio-card">
                            <div class="doc-servicio-header">
                                <div class="doc-servicio-info">
                                    <span class="doc-servicio-tipo">{{ doc_servicio.documento_requerido.nombre }}</span>
                                    <span class="doc-servicio-label {% if doc_servicio.documento_requerido.obligatorio %}obligatorio{% else %}opcional{% endif %}">
                                        {% if doc_servicio.documento_requerido.obligatorio %}Obligatorio{% else %}Opcional{% endif %}
                                    </span>
                                </div>
                                <span class="doc-servicio-servicio">{{ doc_servicio.documento_requerido.servicio.codigo }}</span>
                            </div>
                            <div class="doc-servicio-body">
                                <div class="doc-servicio-archivo">
                                    <span class="doc-icon">
                                        {% if '.pdf' in doc_servicio.nombre_original|lower %}üìï
                                        {% elif '.doc' in doc_servicio.nombre_original|lower %}üìò
                                        {% elif '.jpg' in doc_servicio.nombre_original|lower or '.jpeg' in doc_servicio.nombre_original|lower or '.png' in doc_servicio.nombre_original|lower %}üñºÔ∏è
                                        {% else %}üìÑ{% endif %}
                                    </span>
                                    <div class="doc-archivo-info">
                                        <span class="doc-nombre">{{ doc_servicio.nombre_original }}</span>
                                        <span class="doc-size">{{ doc_servicio.tama√±o|filesizeformat }}</span>
                                    </div>
                                </div>
                                <div class="doc-servicio-actions">
                                    <button type="button" class="btn-preview" onclick="previewDocument('{{ doc_servicio.archivo.url }}', '{{ doc_servicio.nombre_original }}')" title="Vista previa">
                                        üëÅÔ∏è Vista Previa
                                    </button>
                                    <a href="{{ doc_servicio.archivo.url }}" target="_blank" class="btn-download" title="Descargar">
                                        ‚¨áÔ∏è Descargar
                                    </a>
                                </div>
                            </div>
                            {% if doc_servicio.verificado %}
                            <div class="doc-verificado">
                                ‚úÖ Verificado por {{ doc_servicio.verificado_por.get_display_name|default:"Sistema" }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="margin-top: 15px; padding: 20px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; text-align: center; color: #6c757d;">
                        <span style="font-size: 24px; display: block; margin-bottom: 10px;">üì≠</span>
                        <strong>No hay documentos adjuntos</strong>
                        <p style="margin: 5px 0 0; font-size: 13px;">El solicitante no ha adjuntado documentos para los servicios seleccionados.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Personal Asignado -->
            {% if personal_asignado %}
            <div class="form-container" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">üë• Personal Asignado</h3>
                <div class="data-table">
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>C√©dula</th>
                                    <th>Cargo</th>
                                    <th>Tel√©fono</th>
                                    <th>Rol en Operaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asignacion in personal_asignado %}
                                <tr>
                                    <td><strong>{{ asignacion.personal.nombre }}</strong></td>
                                    <td>{{ asignacion.personal.cedula }}</td>
                                    <td>{{ asignacion.personal.cargo|default:'-' }}</td>
                                    <td>{{ asignacion.personal.telefono|default:'-' }}</td>
                                    <td>{{ asignacion.rol_operacion|default:'-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Veh√≠culos -->
            {% if vehiculos %}
            <div class="form-container" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">üöó Veh√≠culos Registrados</h3>
                <div class="data-table">
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Tipo</th>
                                    <th>Conductor</th>
                                    <th>Licencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vehiculo in vehiculos %}
                                <tr>
                                    <td><strong>{{ vehiculo.placa }}</strong></td>
                                    <td>{{ vehiculo.get_tipo_vehiculo_display }}</td>
                                    <td>{{ vehiculo.conductor_nombre }}</td>
                                    <td>{{ vehiculo.conductor_licencia|default:'-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Documentos -->
            {% if documentos %}
            <div class="form-container" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">üìÑ Documentos Adjuntos</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    {% for documento in documentos %}
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">
                            {% if documento.tipo_documento == 'cedula_representante' %}üìÑ
                            {% elif documento.tipo_documento == 'rnc_empresa' %}üè¢
                            {% elif documento.tipo_documento == 'registro_vehiculo' %}üöó
                            {% else %}üìã{% endif %}
                        </div>
                        <h5>{{ documento.get_tipo_documento_display }}</h5>
                        <p style="font-size: 14px; color: #7f8c8d;">{{ documento.nombre_original }}</p>
                        <a href="{{ documento.archivo.url }}" target="_blank" class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;">Ver Documento</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Panel de Evaluaci√≥n -->
        <div>
            <div class="form-container">
                <h3 style="color: #2c3e50; margin-bottom: 25px;">‚öñÔ∏è Panel de Evaluaci√≥n</h3>

                <!-- Estado y Prioridad -->
                {% with estado_info=solicitud.estado_con_color %}
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Estado Actual:</strong></span>
                        <span style="background: {{ estado_info.bg_color }}; color: {{ estado_info.text_color|default:'white' }}; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 500;">{{ estado_info.icono }} {{ estado_info.texto }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Prioridad:</strong></span>
                        <span class="status-badge {% if solicitud.prioridad == 'critica' or solicitud.prioridad == 'vip' %}status-critical{% elif solicitud.prioridad == 'alta' %}status-high{% else %}status-normal{% endif %}">{{ solicitud.get_prioridad_display }}</span>
                    </div>
                    {% if solicitud.vence_el %}
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>Vence el:</strong></span>
                        <span style="color: {% if solicitud.vence_el|date:'Y-m-d' == today %}#e74c3c{% else %}#f39c12{% endif %};">{{ solicitud.vence_el|date:'d/m/Y H:i' }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endwith %}

                {% if not puede_evaluar %}
                <!-- Mensaje de advertencia cuando no se puede evaluar -->
                <div class="alert alert-warning" style="background-color: #fff3cd; border: 1px solid #ffecb5; color: #856404; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
                    <strong>‚ö†Ô∏è Solo lectura:</strong> Esta solicitud est√° en estado "{{ solicitud.get_estado_display }}" y no puede ser evaluada. Solo puedes ver su informaci√≥n.
                </div>
                {% endif %}

                <!-- Formulario de Evaluaci√≥n -->
                <form method="post">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="form-group">
                        {{ form.comentario.label_tag }}
                        <textarea name="comentario" rows="4" class="form-control" placeholder="Ingrese sus comentarios sobre la evaluaci√≥n de esta solicitud..." {% if not puede_evaluar %}disabled readonly style="background-color: #f0f0f0; cursor: not-allowed;"{% endif %}>{{ form.comentario.value|default:'' }}</textarea>
                        {% if form.comentario.errors %}
                            <div class="error">{{ form.comentario.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Decisi√≥n *</label>
                        <div style="margin-top: 10px;">
                            {% for choice in form.accion %}
                                <div style="margin-bottom: 10px; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; {% if not puede_evaluar %}background-color: #f0f0f0; opacity: 0.6;{% endif %} cursor: pointer; transition: all 0.2s;" class="accion-option">
                                    {{ choice.tag }}
                                    <label for="{{ choice.id_for_label }}" style="margin-left: 8px; cursor: {% if puede_evaluar %}pointer{% else %}not-allowed{% endif %}; font-size: 14px;">{{ choice.choice_label }}</label>
                                </div>
                            {% endfor %}
                        </div>
                        {% if form.accion.errors %}
                            <div class="error" style="color: #e74c3c; margin-top: 5px;">{{ form.accion.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <a href="{% url 'evaluacion:dashboard' %}" class="btn" style="background: #95a5a6; color: white; flex: 1; text-align: center;">‚Üê Volver</a>
                        {% if puede_evaluar %}
                        <button type="submit" class="btn btn-primary" style="flex: 2;">üíæ Guardar Evaluaci√≥n</button>
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- Informaci√≥n adicional -->
            <div class="form-container" style="margin-top: 20px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px;">üìä Informaci√≥n del Proceso</h4>
                <div style="font-size: 14px;">
                    <p><strong>Creada el:</strong> {{ solicitud.creada_el|date:'d/m/Y H:i' }}</p>
                    {% if solicitud.enviada_el %}
                    <p><strong>Enviada el:</strong> {{ solicitud.enviada_el|date:'d/m/Y H:i' }}</p>
                    {% endif %}
                    {% if solicitud.evaluador_asignado %}
                    <p><strong>Evaluador:</strong> {{ solicitud.evaluador_asignado.get_display_name }}</p>
                    {% endif %}
                    <p><strong>Tiempo l√≠mite:</strong> {{ solicitud.tiempo_limite_horas }} horas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline de Eventos -->
    <div class="timeline-container" style="margin-top: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
            ‚è∞ L√≠nea de Tiempo de la Solicitud
        </h3>
        <div id="solicitudTimeline"></div>
    </div>
</div>

<!-- Cargar estilos y scripts del timeline -->
<link rel="stylesheet" href="{% static 'solicitudes/css/timeline.css' %}">
<script src="{% static 'solicitudes/js/timeline.js' %}"></script>

<style>
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-review { background: #cce5ff; color: #0056b3; }
.status-critical { background: #f8d7da; color: #721c24; }
.status-high { background: #fff3cd; color: #856404; }
.status-normal { background: #d1ecf1; color: #0c5460; }

.error {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
}

.alert {
    padding: 12px;
    margin-bottom: 20px;
    border-radius: 4px;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c2c7;
    color: #842029;
}

input[type="radio"] {
    margin-right: 8px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Estilos para opciones de acci√≥n */
.accion-option {
    display: flex;
    align-items: center;
}

.accion-option:hover {
    border-color: #3498db !important;
    background-color: #f8f9fa;
}

.accion-option:has(input:checked) {
    border-color: #3498db !important;
    background-color: #e3f2fd !important;
}

.form-group {
    margin-bottom: 20px;
}

/* Bot√≥n de Imprimir */
.btn-imprimir {
    background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
}

.btn-imprimir:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
}

/* Bot√≥n de Imprimir Autorizaci√≥n */
.btn-imprimir-autorizacion {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
}

.btn-imprimir-autorizacion:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
    color: white;
    text-decoration: none;
}

/* Estilos de Impresi√≥n */
@media print {
    /* Ocultar elementos innecesarios */
    .navbar,
    .no-print,
    .btn-imprimir,
    .wizard-form-actions,
    form,
    .preview-modal-overlay {
        display: none !important;
    }

    /* Ajustar layout para impresi√≥n */
    .content-area {
        padding: 0 !important;
        margin: 0 !important;
    }

    body {
        background: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* Hacer que todo sea de una columna */
    div[style*="grid-template-columns: 2fr 1fr"] {
        display: block !important;
    }

    /* Mostrar solo informaci√≥n, no panel de evaluaci√≥n */
    div[style*="grid-template-columns: 2fr 1fr"] > div:last-child {
        display: none !important;
    }

    .form-container {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 15px !important;
        box-shadow: none !important;
        border: 1px solid #dee2e6 !important;
    }

    /* Encabezado de impresi√≥n */
    h2 {
        font-size: 18px !important;
    }

    h3 {
        font-size: 14px !important;
    }

    /* Tablas */
    table {
        font-size: 12px !important;
    }

    /* Badges de servicios */
    .documentos-servicios-grid {
        display: block !important;
    }

    .documento-servicio-card {
        margin-bottom: 10px !important;
        break-inside: avoid;
    }
}

/* Estilos para Documentos de Servicios */
.documentos-servicios-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
}

.documento-servicio-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.documento-servicio-card:hover {
    border-color: #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.15);
}

.doc-servicio-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 1px solid #e9ecef;
}

.doc-servicio-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.doc-servicio-tipo {
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
}

.doc-servicio-label {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
    display: inline-block;
    width: fit-content;
}

.doc-servicio-label.obligatorio {
    background: #fee2e2;
    color: #dc2626;
}

.doc-servicio-label.opcional {
    background: #f3f4f6;
    color: #6b7280;
}

.doc-servicio-servicio {
    background: #3498db;
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
}

.doc-servicio-body {
    padding: 15px;
}

.doc-servicio-archivo {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
}

.doc-icon {
    font-size: 28px;
}

.doc-archivo-info {
    display: flex;
    flex-direction: column;
    gap: 3px;
    flex: 1;
    min-width: 0;
}

.doc-nombre {
    font-weight: 500;
    color: #2c3e50;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.doc-size {
    font-size: 11px;
    color: #7f8c8d;
}

.doc-servicio-actions {
    display: flex;
    gap: 10px;
}

.btn-preview, .btn-download {
    flex: 1;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-preview {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    border: 2px solid #0ea5e9;
    color: #0369a1;
}

.btn-preview:hover {
    background: #0ea5e9;
    color: white;
}

.btn-download {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    border: 2px solid #22c55e;
    color: #166534;
}

.btn-download:hover {
    background: #22c55e;
    color: white;
    text-decoration: none;
}

.doc-verificado {
    background: #dcfce7;
    color: #166534;
    padding: 10px 15px;
    font-size: 12px;
    font-weight: 500;
    border-top: 1px solid #bbf7d0;
}

/* Modal de Vista Previa */
.preview-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.preview-modal-overlay.active {
    display: flex;
}

.preview-modal {
    background: white;
    border-radius: 16px;
    max-width: 90vw;
    max-height: 90vh;
    width: 900px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
}

.preview-modal-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 16px 16px 0 0;
}

.preview-modal-header h4 {
    margin: 0;
    color: #2c3e50;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: calc(100% - 50px);
}

.preview-close-btn {
    background: #e74c3c;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.preview-close-btn:hover {
    background: #c0392b;
    transform: scale(1.1);
}

.preview-modal-body {
    flex: 1;
    overflow: auto;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #1a1a1a;
}

.preview-modal-body iframe {
    width: 100%;
    height: 70vh;
    border: none;
}

.preview-modal-body img {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
}

.preview-not-available {
    color: white;
    text-align: center;
    padding: 40px;
}

.preview-not-available i {
    font-size: 48px;
    margin-bottom: 20px;
    display: block;
}
</style>

<!-- Modal de Vista Previa -->
<div class="preview-modal-overlay" id="previewModal">
    <div class="preview-modal">
        <div class="preview-modal-header">
            <h4 id="previewTitle">Vista Previa</h4>
            <button type="button" class="preview-close-btn" onclick="closePreview()">‚úï</button>
        </div>
        <div class="preview-modal-body" id="previewBody">
            <!-- El contenido se carga din√°micamente -->
        </div>
    </div>
</div>

<script>
function previewDocument(url, filename) {
    const modal = document.getElementById('previewModal');
    const title = document.getElementById('previewTitle');
    const body = document.getElementById('previewBody');

    title.textContent = filename;

    const ext = filename.toLowerCase().split('.').pop();

    if (ext === 'pdf') {
        body.innerHTML = `<iframe src="${url}" title="Vista previa de ${filename}"></iframe>`;
    } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
        body.innerHTML = `<img src="${url}" alt="${filename}">`;
    } else {
        body.innerHTML = `
            <div class="preview-not-available">
                <span style="font-size: 48px;">üìÑ</span>
                <p>Vista previa no disponible para este tipo de archivo.</p>
                <a href="${url}" target="_blank" style="color: #3498db;">Abrir en nueva pesta√±a</a>
            </div>
        `;
    }

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closePreview() {
    const modal = document.getElementById('previewModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
    document.getElementById('previewBody').innerHTML = '';
}

// Cerrar modal con Escape o clic fuera
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closePreview();
});

document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) closePreview();
});

// Inicializar Timeline
document.addEventListener('DOMContentLoaded', function() {
    const eventosData = {{ eventos_json|safe }};

    if (eventosData && eventosData.length > 0) {
        const timeline = new SolicitudTimeline('solicitudTimeline', eventosData);
    } else {
        // Mostrar mensaje de timeline vac√≠o
        document.getElementById('solicitudTimeline').innerHTML = `
            <div class="timeline-empty">
                <div class="empty-icon">‚è∞</div>
                <h3>Sin eventos registrados</h3>
                <p>Esta solicitud a√∫n no tiene eventos en su historial.</p>
            </div>
        `;
    }
});
</script>
{% endblock %} 
{% extends 'base.html' %}

{% block title %}Renovar Licencia | NaviPort RD{% endblock %}

{% block content %}
{% include 'includes/navbar_evaluador.html' with active_page='config' %}

<div class="content-area">
    <div style="margin-bottom: 30px;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
            <a href="{% url 'evaluacion:gestionar_empresas' %}" class="btn" style="background: #6c757d; color: white;">
                ‚Üê Volver
            </a>
            <h2 style="color: #2c3e50; margin: 0;">
                üîÑ Renovar Licencia
            </h2>
        </div>
        <p style="color: #7f8c8d;">{{ user.get_display_name }} ‚Ä¢ Evaluador Portuario</p>
    </div>

    <div class="data-table">
        <div class="table-header">
            <div class="table-title">Renovaci√≥n de Licencia</div>
        </div>
        
        <div style="padding: 30px;">
            <!-- Informaci√≥n de la Empresa -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #3498db; margin-bottom: 30px;">
                <h3 style="color: #2c3e50; margin: 0 0 15px 0;">üìã Informaci√≥n de la Empresa</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px;">
                    <div>
                        <strong>Nombre:</strong> {{ empresa.nombre }}
                    </div>
                    <div>
                        <strong>RNC:</strong> {{ empresa.rnc }}
                    </div>
                    <div>
                        <strong>Representante:</strong> {{ empresa.representante_legal.get_display_name }}
                    </div>
                    <div>
                        <strong>Email:</strong> {{ empresa.email }}
                    </div>
                </div>
            </div>

            <!-- Estado Actual de la Licencia -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #f39c12; margin-bottom: 30px;">
                <h3 style="color: #2c3e50; margin: 0 0 15px 0;">üìú Estado Actual de la Licencia</h3>
                {% with estado=empresa.estado_licencia %}
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 14px;">
                    <div>
                        <strong>N√∫mero:</strong> {{ empresa.numero_licencia|default:"N/A" }}
                    </div>
                    <div>
                        <strong>Fecha de Expedici√≥n:</strong> {{ empresa.fecha_expedicion_licencia|date:"d/m/Y"|default:"N/A" }}
                    </div>
                    <div>
                        <strong>Fecha de Expiraci√≥n:</strong> {{ empresa.fecha_expiracion_licencia|date:"d/m/Y"|default:"N/A" }}
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <strong>Estado:</strong>
                    {% if estado.color == 'green' %}
                        <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; margin-left: 10px;">
                            ‚úÖ {{ estado.texto }}
                        </span>
                    {% elif estado.color == 'orange' %}
                        <span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; margin-left: 10px;">
                            ‚ö†Ô∏è {{ estado.texto }}
                        </span>
                    {% elif estado.color == 'red' %}
                        <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; margin-left: 10px;">
                            ‚ùå {{ estado.texto }}
                        </span>
                    {% else %}
                        <span style="background: #95a5a6; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; margin-left: 10px;">
                            üìÑ {{ estado.texto }}
                        </span>
                    {% endif %}
                    
                    {% if empresa.fecha_expiracion_licencia %}
                        <div style="margin-top: 10px; font-size: 13px; color: #6c757d;">
                            {% if empresa.dias_para_vencimiento > 0 %}
                                ‚è∞ Vence en {{ empresa.dias_para_vencimiento }} d√≠a{{ empresa.dias_para_vencimiento|pluralize:"s" }}
                            {% elif empresa.dias_para_vencimiento < 0 %}
                                ‚è∞ Vencida hace {{ empresa.dias_para_vencimiento|cut:"-" }} d√≠a{{ empresa.dias_para_vencimiento|cut:"-"|pluralize:"s" }}
                            {% else %}
                                ‚è∞ Vence hoy
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% endwith %}
            </div>

            <!-- Formulario de Renovaci√≥n -->
            <form method="POST">
                {% csrf_token %}
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 4px solid #27ae60; margin-bottom: 30px;">
                    <h3 style="color: #2c3e50; margin: 0 0 15px 0;">üîÑ Renovaci√≥n de Licencia</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="fecha_expiracion" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">
                            Nueva Fecha de Expiraci√≥n *
                        </label>
                        <input type="date" 
                               id="fecha_expiracion" 
                               name="fecha_expiracion" 
                               value="{{ fecha_sugerida }}"
                               min="{{ fecha_sugerida }}"
                               required
                               style="width: 250px; padding: 10px; border: 2px solid #27ae60; border-radius: 4px; font-size: 14px;">
                        <div style="margin-top: 8px; font-size: 13px; color: #6c757d;">
                            üí° Se sugiere renovar por un a√±o adicional desde hoy
                        </div>
                    </div>

                    <!-- Opciones de Renovaci√≥n R√°pida -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">
                            Opciones R√°pidas:
                        </label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" onclick="setFecha(6)" class="btn btn-sm" style="background: #17a2b8; color: white;">6 meses</button>
                            <button type="button" onclick="setFecha(12)" class="btn btn-sm" style="background: #28a745; color: white;">1 a√±o</button>
                            <button type="button" onclick="setFecha(24)" class="btn btn-sm" style="background: #6f42c1; color: white;">2 a√±os</button>
                            <button type="button" onclick="setFecha(36)" class="btn btn-sm" style="background: #fd7e14; color: white;">3 a√±os</button>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Proceso -->
                    <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #d4edda; margin-bottom: 20px;">
                        <h4 style="color: #155724; margin: 0 0 10px 0;">‚ÑπÔ∏è Informaci√≥n del Proceso</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #155724; font-size: 13px;">
                            <li>La renovaci√≥n actualizar√° autom√°ticamente la fecha de expiraci√≥n</li>
                            <li>Se mantendr√° el n√∫mero de licencia actual</li>
                            <li>Se registrar√° la fecha y usuario que realiz√≥ la renovaci√≥n</li>
                            <li>La empresa ser√° notificada sobre la renovaci√≥n por email</li>
                        </ul>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div style="padding-top: 20px; border-top: 1px solid #dee2e6; display: flex; gap: 15px; justify-content: flex-end;">
                    <a href="{% url 'evaluacion:gestionar_empresas' %}" class="btn" style="background: #6c757d; color: white; padding: 12px 24px;">
                        Cancelar
                    </a>
                    <button type="submit" class="btn" style="background: #28a745; color: white; padding: 12px 24px;" onclick="return confirm('¬øEst√° seguro de renovar la licencia de {{ empresa.nombre }}?')">
                        üîÑ Renovar Licencia
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function setFecha(meses) {
    const fecha = new Date();
    fecha.setMonth(fecha.getMonth() + meses);
    document.getElementById('fecha_expiracion').value = fecha.toISOString().split('T')[0];
}

document.addEventListener('DOMContentLoaded', function() {
    // Validar que la fecha sea futura
    document.getElementById('fecha_expiracion').addEventListener('change', function() {
        const fechaSeleccionada = new Date(this.value);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        if (fechaSeleccionada <= hoy) {
            alert('La fecha de expiraci√≥n debe ser posterior a hoy');
            this.value = '{{ fecha_sugerida }}';
        }
    });
});
</script>

{% endblock %}
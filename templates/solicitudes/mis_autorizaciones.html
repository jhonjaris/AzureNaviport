{% extends 'base.html' %}
{% load static %}
{% load notificaciones_tags %}

{% block title %}Mis Autorizaciones | NaviPort RD{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'solicitudes/css/solicitudes.css' %}">
{% endblock %}

{% block content %}
<div class="navbar">
    <div class="navbar-brand">
        <div class="logo">NP</div>
        NaviPort RD
    </div>
    <ul class="navbar-menu">
        <li><a href="{% url 'solicitudes:dashboard' %}" style="color: inherit; text-decoration: none;">ğŸ  Dashboard</a></li>
        <li><a href="{% url 'solicitudes:solicitud_wizard_inicio' %}" style="color: inherit; text-decoration: none;">â• Nueva Solicitud</a></li>
        <li><a href="{% url 'solicitudes:mis_solicitudes' %}" style="color: inherit; text-decoration: none;">ğŸ“‹ Solicitudes</a></li>
        <li class="active">ğŸ« Autorizaciones</li>
        <li><a href="{% url 'solicitudes:estadisticas' %}" style="color: inherit; text-decoration: none;">ğŸ“Š EstadÃ­sticas</a></li>
        <li><a href="{% url 'accounts:ayuda' %}" style="color: inherit; text-decoration: none;">â“ Ayuda</a></li>
    </ul>
    <div class="navbar-user">
        <div style="text-align: right; margin-right: 10px;">
            <div class="user-name">{{ user.get_display_name }}</div>
            <div style="font-size: 14px; color: #7f8c8d;">{{ user.get_role_display_with_admin }}</div>
        </div>
        <div class="user-avatar">{{ user.get_display_name|slice:':1'|upper }}{{ user.last_name|slice:':1'|upper }}</div>
        <div class="user-dropdown">
            <a href="{% url 'accounts:logout' %}" class="logout-link">ğŸšª Salir</a>
        </div>
    </div>
</div>

<!-- Barra de Notificaciones -->
{% csrf_token %}
{% get_notificaciones as notificaciones_lista %}
{% if notificaciones_lista %}
{% mostrar_notificaciones_lista notificaciones_lista user %}
{% endif %}

<div class="content-area">
    <div style="margin-bottom: 30px;">
        <h2 style="color: #2c3e50; margin-bottom: 10px;">ğŸ« Mis Autorizaciones</h2>
        <p style="color: #7f8c8d;">{{ user.get_display_name }} â€¢ Solicitante â€¢ {{ total_autorizaciones }} autorizaciÃ³n{{ total_autorizaciones|pluralize:"es" }}</p>
    </div>

    <!-- BotÃ³n de navegaciÃ³n -->
    <div style="margin-bottom: 30px;">
        <a href="{% url 'solicitudes:dashboard' %}" class="btn btn-secondary">â† Dashboard</a>
        <a href="{% url 'solicitudes:mis_solicitudes' %}" class="btn btn-info">ğŸ“‹ Ver Solicitudes</a>
    </div>

    {% if autorizaciones %}
    <div class="data-table">
        <div class="table-header">
            <div class="table-title">ğŸ« Autorizaciones Vigentes</div>
            <div>
                <span style="color: #27ae60; font-weight: bold;">{{ total_autorizaciones }} autorizaciÃ³n{{ total_autorizaciones|pluralize:"es" }} activa{{ total_autorizaciones|pluralize:"s" }}</span>
            </div>
        </div>
        <div class="table-content">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID / CÃ³digo</th>
                        <th>Puerto Autorizado</th>
                        <th>Motivo</th>
                        <th>Vigencia</th>
                        <th>Estado</th>
                        <th>Aprobada</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                {% for auth in autorizaciones %}
                    <tr>
                        <td>
                            <strong>{{ auth.codigo|default:auth.id }}</strong>
                            <br><small style="color: #27ae60; font-style: italic;">ğŸ« AutorizaciÃ³n</small>
                        </td>
                        <td>
                            <strong>{{ auth.puerto_destino }}</strong>
                            <br><small style="color: #666;">{{ auth.empresa.nombre|truncatechars:30 }}</small>
                        </td>
                        <td>{{ auth.motivo_acceso }}</td>
                        <td>
                            <strong style="color: #27ae60;">{{ auth.fecha_ingreso|date:"d/m/Y" }}</strong> - <strong style="color: #e74c3c;">{{ auth.fecha_salida|date:"d/m/Y" }}</strong>
                            <br><small style="color: #666;">{{ auth.hora_ingreso|time:"H:i" }} - {{ auth.hora_salida|time:"H:i" }}</small>
                        </td>
                        <td>
                            <span class="status-badge status-approved">âœ… Aprobada</span>
                        </td>
                        <td>
                            <span style="color: #666;">{{ auth.modificada_el|date:"d/m/Y" }}</span>
                            <br><small style="color: #999;">{{ auth.modificada_el|date:"H:i" }}</small>
                        </td>
                        <td style="white-space: nowrap;">
                            <a href="{% url 'solicitudes:detalle_solicitud' auth.id %}" class="btn btn-sm btn-success" title="Ver autorizaciÃ³n">ğŸ« Ver</a>
                            <button class="btn btn-sm btn-info" title="Descargar QR" onclick="alert('Funcionalidad de QR pendiente')">ğŸ“± QR</button>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="7" style="text-align:center;">No hay autorizaciones disponibles.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PaginaciÃ³n -->
    {% if autorizaciones.has_other_pages %}
    <div class="pagination" style="text-align: center; margin: 20px 0;">
        {% if autorizaciones.has_previous %}
            <a href="?page={{ autorizaciones.previous_page_number }}" class="btn btn-primary">â† Anterior</a>
        {% endif %}
        
        <span style="margin: 0 15px;">
            PÃ¡gina {{ autorizaciones.number }} de {{ autorizaciones.paginator.num_pages }}
        </span>
        
        {% if autorizaciones.has_next %}
            <a href="?page={{ autorizaciones.next_page_number }}" class="btn btn-primary">Siguiente â†’</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="form-container" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ«</div>
        <h3 style="color: #7f8c8d; margin-bottom: 15px;">No tienes autorizaciones activas</h3>
        <p style="color: #95a5a6; margin-bottom: 30px;">
            Las autorizaciones se generan automÃ¡ticamente cuando tus solicitudes son aprobadas por los evaluadores.
        </p>
        <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h6 style="color: #27ae60; margin-bottom: 10px;">ğŸ’¡ Â¿CÃ³mo obtener una autorizaciÃ³n?</h6>
            <div style="text-align: left; color: #666;">
                <p style="margin: 5px 0;">1ï¸âƒ£ Crea una nueva solicitud de acceso</p>
                <p style="margin: 5px 0;">2ï¸âƒ£ Completa todos los datos requeridos</p>
                <p style="margin: 5px 0;">3ï¸âƒ£ EnvÃ­a la solicitud para evaluaciÃ³n</p>
                <p style="margin: 5px 0;">4ï¸âƒ£ Espera la aprobaciÃ³n del evaluador</p>
                <p style="margin: 5px 0;">5ï¸âƒ£ Tu autorizaciÃ³n aparecerÃ¡ aquÃ­ automÃ¡ticamente</p>
            </div>
        </div>
        <a href="{% url 'solicitudes:solicitud_wizard_inicio' %}" class="btn btn-primary" style="padding: 15px 30px;">
            ğŸ“ Crear Nueva Solicitud
        </a>
        <br><br>
        <a href="{% url 'solicitudes:mis_solicitudes' %}" class="btn btn-secondary">Ver Mis Solicitudes</a>
    </div>
    {% endif %}
</div>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} | NaviPort RD{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'empresas/css/empresas.css' %}">
{% endblock %}

{% block content %}
<div class="navbar">
    <div class="navbar-brand">
        <div class="logo">NP</div>
        NaviPort RD
    </div>
    <ul class="navbar-menu">
        <li><a href="{% url 'evaluacion:dashboard' %}" style="color: inherit; text-decoration: none;">Dashboard</a></li>
        <li>Evaluaciones</li>
        <li>Reportes</li>
        <li class="active">Registrar Empresa</li>
        <li>Configuraci√≥n</li>
    </ul>
    <div class="navbar-user">
        <div style="text-align: right; margin-right: 10px;">
            <div style="font-weight: 500;">{{ user.get_display_name }}</div>
            <div style="font-size: 14px; color: #7f8c8d;">{{ user.get_role_display_with_admin }}</div>
        </div>
        <div class="user-avatar">{{ user.get_display_name|slice:':1'|upper }}{{ user.last_name|slice:':1'|upper }}</div>
        <div class="user-dropdown">
            <a href="{% url 'accounts:logout' %}" class="logout-link">üö™ Salir</a>
        </div>
    </div>
</div>

<div class="content-area">
    <div style="margin-bottom: 30px;">
        <h2 style="color: #2c3e50; margin-bottom: 10px;">{{ title }}</h2>
        <p style="color: #7f8c8d;">{{ user.get_display_name }} ‚Ä¢ {% if user.role == 'evaluador' %}Evaluador Portuario{% else %}Supervisor{% endif %}</p>
    </div>

    <div class="form-container" style="max-width: none;">
        <form method="post" id="empresaForm">
            {% csrf_token %}
            
            <!-- Informaci√≥n B√°sica -->
            <div class="form-section">
                <h4>üìã Informaci√≥n B√°sica</h4>
                <div class="row">
                    <div class="col-md-4">
                        <label for="{{ form.rnc.id_for_label }}" class="form-label">{{ form.rnc.label }} *</label>
                        {{ form.rnc }}
                        {% if form.rnc.errors %}
                            <div class="text-danger">{{ form.rnc.errors }}</div>
                        {% endif %}
                        <div class="form-text">Formato: XXX-XXXXX-X</div>
                    </div>
                    <div class="col-md-8">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }} *</label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                            <div class="text-danger">{{ form.nombre.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n de Contacto -->
            <div class="form-section">
                <h4>üìû Informaci√≥n de Contacto</h4>
                <div class="row">
                    <div class="col-md-4">
                        <label for="{{ form.telefono.id_for_label }}" class="form-label">{{ form.telefono.label }}</label>
                        {{ form.telefono }}
                        {% if form.telefono.errors %}
                            <div class="text-danger">{{ form.telefono.errors }}</div>
                        {% endif %}
                        <div class="form-text">Formato: XXX-XXX-XXXX</div>
                    </div>
                    <div class="col-md-8">
                        <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <label for="{{ form.direccion.id_for_label }}" class="form-label">{{ form.direccion.label }}</label>
                        {{ form.direccion }}
                        {% if form.direccion.errors %}
                            <div class="text-danger">{{ form.direccion.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n de Licencia -->
            <div class="form-section">
                <h4>üìú Informaci√≥n de Licencia</h4>
                <div class="row">
                    <div class="col-md-6">
                        <label for="{{ form.numero_licencia.id_for_label }}" class="form-label">{{ form.numero_licencia.label }} *</label>
                        {{ form.numero_licencia }}
                        {% if form.numero_licencia.errors %}
                            <div class="text-danger">{{ form.numero_licencia.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.fecha_expiracion_licencia.id_for_label }}" class="form-label">{{ form.fecha_expiracion_licencia.label }} *</label>
                        {{ form.fecha_expiracion_licencia }}
                        {% if form.fecha_expiracion_licencia.errors %}
                            <div class="text-danger">{{ form.fecha_expiracion_licencia.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Servicios Autorizados -->
            <div class="form-section">
                <h4>üîß Servicios Autorizados</h4>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Seleccione los servicios que la empresa est√° autorizada a ofrecer:</p>
                
                {% if servicios %}
                    <div id="serviciosContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        {% for servicio in servicios %}
                            <div class="service-checkbox">
                                <input type="checkbox" 
                                       name="{{ form.servicios_autorizados.name }}" 
                                       value="{{ servicio.id }}" 
                                       id="servicio_{{ servicio.id }}"
                                       class="form-check-input me-3"
                                       {% if empresa and servicio in empresa.servicios_autorizados.all %}checked{% endif %}>
                                <label for="servicio_{{ servicio.id }}" class="form-check-label" style="flex: 1; cursor: pointer;">
                                    <strong>{{ servicio.nombre }}</strong>
                                    {% if servicio.descripcion %}
                                        <br><small style="color: #666;">{{ servicio.descripcion }}</small>
                                    {% endif %}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleAllServices()">
                            <span id="toggleText">Seleccionar Todos</span>
                        </button>
                        <a href="{% url 'empresas:crear_servicio' %}" class="btn btn-outline-secondary btn-sm ms-2">
                            ‚ûï Crear Nuevo Servicio
                        </a>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        No hay servicios disponibles. 
                        <a href="{% url 'empresas:crear_servicio' %}" class="btn btn-primary btn-sm ms-2">
                            Crear Primer Servicio
                        </a>
                    </div>
                {% endif %}
                
                {% if form.servicios_autorizados.errors %}
                    <div class="text-danger mt-2">{{ form.servicios_autorizados.errors }}</div>
                {% endif %}
            </div>

            <!-- Estado -->
            <div class="form-section">
                <h4>‚öôÔ∏è Estado</h4>
                <div class="form-check">
                    {{ form.activa }}
                    <label class="form-check-label" for="{{ form.activa.id_for_label }}">
                        {{ form.activa.label }}
                    </label>
                </div>
                {% if form.activa.errors %}
                    <div class="text-danger">{{ form.activa.errors }}</div>
                {% endif %}
            </div>

            <!-- Botones de Acci√≥n -->
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                <a href="{% url 'empresas:listar_empresas' %}" class="btn btn-secondary" style="padding: 15px 30px;">‚Ü©Ô∏è Cancelar</a>
                <button type="submit" class="btn btn-primary" style="padding: 15px 30px;">
                    {% if empresa %}üíæ Actualizar Empresa{% else %}üè¢ Registrar Empresa{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Formateo autom√°tico para RNC
    function formatRNC(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 9) {
            value = value.substring(0, 9);
        }
        
        let formatted = '';
        if (value.length > 0) {
            if (value.length <= 3) {
                formatted = value;
            } else if (value.length <= 8) {
                formatted = value.substring(0, 3) + '-' + value.substring(3);
            } else {
                formatted = value.substring(0, 3) + '-' + value.substring(3, 8) + '-' + value.substring(8);
            }
        }
        
        input.value = formatted;
    }
    
    // Formateo autom√°tico para tel√©fono
    function formatTelefono(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 10) {
            value = value.substring(0, 10);
        }
        
        let formatted = '';
        if (value.length > 0) {
            if (value.length <= 3) {
                formatted = value;
            } else if (value.length <= 6) {
                formatted = value.substring(0, 3) + '-' + value.substring(3);
            } else {
                formatted = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
            }
        }
        
        input.value = formatted;
    }
    
    // Funci√≥n para seleccionar/deseleccionar todos los servicios
    function toggleAllServices() {
        const checkboxes = document.querySelectorAll('#serviciosContainer input[type="checkbox"]');
        const toggleButton = document.getElementById('toggleText');
        
        // Verificar si todos est√°n seleccionados
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        if (allChecked) {
            // Deseleccionar todos
            checkboxes.forEach(cb => cb.checked = false);
            toggleButton.textContent = 'Seleccionar Todos';
        } else {
            // Seleccionar todos
            checkboxes.forEach(cb => cb.checked = true);
            toggleButton.textContent = 'Deseleccionar Todos';
        }
    }
    
    // Configurar validaci√≥n de fechas
    function setupDateValidation() {
        const today = new Date().toISOString().split('T')[0];
        const fechaExpiracionInput = document.getElementById('{{ form.fecha_expiracion_licencia.id_for_label }}');
        
        if (fechaExpiracionInput) {
            fechaExpiracionInput.setAttribute('min', today);
        }
    }
    
    // Inicializar cuando la p√°gina carga
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar formateo autom√°tico
        const rncInput = document.getElementById('{{ form.rnc.id_for_label }}');
        const telefonoInput = document.getElementById('{{ form.telefono.id_for_label }}');
        
        if (rncInput) {
            rncInput.addEventListener('input', function() {
                formatRNC(this);
            });
        }
        
        if (telefonoInput) {
            telefonoInput.addEventListener('input', function() {
                formatTelefono(this);
            });
        }
        
        // Configurar validaci√≥n de fechas
        setupDateValidation();
        
        console.log('‚úÖ Formulario de empresa inicializado');
    });
</script>
{% endblock %}